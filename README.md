# FNO è®­ç»ƒæ¡†æ¶

ä¸€ä¸ªå®Œæ•´çš„ã€ç§‘å­¦çš„ã€å·¥ç¨‹åŒ–çš„ Fourier Neural Operator (FNO) æ·±åº¦å­¦ä¹ è®­ç»ƒæ¡†æ¶ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
FNO/
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ default_config.yaml      # é»˜è®¤é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ datasets.py              # æ•°æ®é›†å®šä¹‰
â”‚   â”œâ”€â”€ model.py                 # FNO æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ trainer.py               # è®­ç»ƒå™¨æ ¸å¿ƒé€»è¾‘
â”‚   â””â”€â”€ utils.py                 # å·¥å…·å‡½æ•°
â”œâ”€â”€ main.py                      # ä¸»å…¥å£ç¨‹åº
â”œâ”€â”€ requirements.txt             # Python ä¾èµ–
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â””â”€â”€ fno_demo.py                  # åŸå§‹æ¼”ç¤ºä»£ç 
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. å‡†å¤‡æ•°æ®

#### ä½¿ç”¨ä¼ªæ•°æ®ï¼ˆæ¼”ç¤ºï¼‰

é»˜è®¤é…ç½®ä½¿ç”¨ä¼ªæ•°æ®ç”Ÿæˆå™¨ï¼Œæ— éœ€å‡†å¤‡æ•°æ®å³å¯è¿è¡Œï¼š
```bash
python main.py
```

#### ä½¿ç”¨çœŸå®æ•°æ®

å¦‚æœæ‚¨æœ‰çœŸå®çš„OTæ•°æ®ï¼Œè¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç»„ç»‡ï¼š

**å›¾åƒç›®å½•ç»“æ„ï¼š**
```
/path/to/images/
â”œâ”€â”€ 1_image_name.jpg
â”œâ”€â”€ 2_image_name.png
â”œâ”€â”€ 3_another_image.jpg
â””â”€â”€ ...
```

**OTç½‘æ ¼ç›®å½•ç»“æ„ï¼š**
```
/path/to/meshes/
â”œâ”€â”€ 1_mesh_name.m
â”œâ”€â”€ 2_mesh_name.m
â”œâ”€â”€ 3_another_mesh.m
â””â”€â”€ ...
```

**è¦æ±‚ï¼š**
- å›¾åƒå¿…é¡»æ˜¯ç°åº¦å›¾ï¼ˆæˆ–å¯è½¬æ¢ä¸ºç°åº¦ï¼‰
- æ–‡ä»¶åå‰ç¼€æ•°å­—ç”¨äºåŒ¹é…å›¾åƒå’Œç½‘æ ¼æ–‡ä»¶ï¼ˆå¦‚ `1_xxx.jpg` å¯¹åº” `1_xxx.m`ï¼‰
- ç½‘æ ¼æ–‡ä»¶æ ¼å¼ï¼šæ¯è¡Œä¸º `Vertex N x y z {rgb=(...) uv=(x y)}`
- ç½‘æ ¼æ–‡ä»¶æŒ‰è¡Œå±•å¼€ï¼Œå¯¹åº”å›¾åƒä»å·¦ä¸Šè§’æŒ‰è¡Œæ‰«æçš„é¡ºåº

**æµ‹è¯•æ•°æ®è¯»å–ï¼š**
```bash
# ä¿®æ”¹ test_real_data.py ä¸­çš„è·¯å¾„ï¼Œç„¶åè¿è¡Œ
python test_real_data.py
```

### 3. è¿è¡Œè®­ç»ƒ

ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆä¼ªæ•°æ®ï¼‰ï¼š
```bash
python main.py
```

ä½¿ç”¨çœŸå®æ•°æ®ï¼š
```bash
# 1. ä¿®æ”¹ configs/real_data_config.yaml ä¸­çš„è·¯å¾„
# 2. è¿è¡Œè®­ç»ƒ
python main.py --config configs/real_data_config.yaml
```

ä½¿ç”¨è‡ªå®šä¹‰é…ç½®ï¼š
```bash
python main.py --config configs/my_config.yaml
```

### 4. æŸ¥çœ‹è®­ç»ƒæ—¥å¿—

è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰è¾“å‡ºä¼šè‡ªåŠ¨ä¿å­˜åˆ° `outputs/` ç›®å½•ä¸‹çš„æ—¶é—´æˆ³æ–‡ä»¶å¤¹ä¸­ã€‚

ä½¿ç”¨ TensorBoard æŸ¥çœ‹è®­ç»ƒæ›²çº¿ï¼š
```bash
tensorboard --logdir=outputs/2025-10-04_15-30-00_FNO_OT/tensorboard
```

## ğŸ“Š è¾“å‡ºç›®å½•ç»“æ„

æ¯æ¬¡è®­ç»ƒä¼šåˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„å®éªŒç›®å½•ï¼š

```
outputs/
â””â”€â”€ 2025-10-04_15-30-00_FNO_OT/
    â”œâ”€â”€ train.log                # è®­ç»ƒæ—¥å¿—
    â”œâ”€â”€ config_snapshot.yaml     # é…ç½®å¿«ç…§ï¼ˆç”¨äºå¤ç°ï¼‰
    â”œâ”€â”€ checkpoints/
    â”‚   â”œâ”€â”€ last.pth            # æœ€æ–°çš„ checkpoint
    â”‚   â””â”€â”€ best_model.pth      # æœ€ä¼˜æ¨¡å‹
    â””â”€â”€ tensorboard/            # TensorBoard æ—¥å¿—
```

## âš™ï¸ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ `configs/default_config.yaml` åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

### è®­ç»ƒå‚æ•° (train_params)
- `learning_rate`: å­¦ä¹ ç‡
- `batch_size`: æ‰¹æ¬¡å¤§å°
- `num_epochs`: è®­ç»ƒè½®æ•°
- `device`: è®¾å¤‡ ('cuda' æˆ– 'cpu')
- `weight_decay`: æƒé‡è¡°å‡
- `gradient_clip`: æ¢¯åº¦è£å‰ªé˜ˆå€¼

### æ•°æ®å‚æ•° (data_params)
- `use_real_data`: æ˜¯å¦ä½¿ç”¨çœŸå®æ•°æ®ï¼ˆtrue/falseï¼‰
- **çœŸå®æ•°æ®å‚æ•°ï¼ˆuse_real_data=trueæ—¶ï¼‰ï¼š**
  - `image_dir`: å›¾åƒç›®å½•è·¯å¾„
  - `mesh_dir`: OTç½‘æ ¼ç›®å½•è·¯å¾„
  - `target_size`: ç›®æ ‡å›¾åƒå°ºå¯¸ [H, W]ï¼ˆnullåˆ™ä¿æŒåŸå°ºå¯¸ï¼‰
  - `use_uv`: ä½¿ç”¨uvåæ ‡è¿˜æ˜¯xyzåæ ‡
  - `train_ratio`: è®­ç»ƒé›†æ¯”ä¾‹
  - `val_ratio`: éªŒè¯é›†æ¯”ä¾‹
- **ä¼ªæ•°æ®å‚æ•°ï¼ˆuse_real_data=falseæ—¶ï¼‰ï¼š**
  - `num_train_samples`: è®­ç»ƒæ ·æœ¬æ•°
  - `num_val_samples`: éªŒè¯æ ·æœ¬æ•°
  - `image_size`: å›¾åƒå°ºå¯¸
- **DataLoaderå‚æ•°ï¼š**
  - `num_workers`: æ•°æ®åŠ è½½çº¿ç¨‹æ•°
  - `pin_memory`: æ˜¯å¦å›ºå®šå†…å­˜

### æ¨¡å‹å‚æ•° (model_params)
- `modes1`: å‚…é‡Œå¶æ¨¡å¼æ•° (xæ–¹å‘)
- `modes2`: å‚…é‡Œå¶æ¨¡å¼æ•° (yæ–¹å‘)
- `width`: éšå±‚å®½åº¦

### æ—¥å¿—å‚æ•° (log_params)
- `log_dir_base`: æ—¥å¿—åŸºç¡€ç›®å½•
- `experiment_name`: å®éªŒåç§°
- `save_freq`: checkpoint ä¿å­˜é¢‘ç‡
- `val_freq`: éªŒè¯é¢‘ç‡

### Checkpoint å‚æ•° (checkpoint_params)
- `resume_from_checkpoint`: æ–­ç‚¹ç»­è®­è·¯å¾„
- `save_best`: æ˜¯å¦ä¿å­˜æœ€ä¼˜æ¨¡å‹

### å­¦ä¹ ç‡è°ƒåº¦å™¨å‚æ•° (scheduler_params)
- `type`: è°ƒåº¦å™¨ç±»å‹ ('StepLR', 'CosineAnnealingLR', 'ReduceLROnPlateau')
- å…¶ä»–å‚æ•°æ ¹æ®è°ƒåº¦å™¨ç±»å‹è€Œå®š

## ğŸ”„ æ–­ç‚¹ç»­è®­

è¦ä»ä¹‹å‰çš„ checkpoint ç»§ç»­è®­ç»ƒï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `resume_from_checkpoint`ï¼š

```yaml
checkpoint_params:
  resume_from_checkpoint: './outputs/2025-10-04_15-30-00_FNO_OT/checkpoints/last.pth'
```

## ğŸ“ æ ¸å¿ƒåŠŸèƒ½

### 1. é…ç½®é©±åŠ¨
æ‰€æœ‰å®éªŒå‚æ•°é€šè¿‡ YAML é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

### 2. è‡ªåŠ¨åŒ–æ—¥å¿—
- è®­ç»ƒæ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶
- TensorBoard å®æ—¶è®°å½•è®­ç»ƒ/éªŒè¯æŸå¤±å’Œå­¦ä¹ ç‡
- æ¯æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»ºå”¯ä¸€çš„å®éªŒç›®å½•

### 3. Checkpoint ç®¡ç†
- è‡ªåŠ¨ä¿å­˜æœ€æ–°æ¨¡å‹ (`last.pth`)
- è‡ªåŠ¨ä¿å­˜æœ€ä¼˜æ¨¡å‹ (`best_model.pth`)
- æ”¯æŒæ–­ç‚¹ç»­è®­

### 4. æ¨¡å—åŒ–è®¾è®¡
- æ•°æ®ã€æ¨¡å‹ã€è®­ç»ƒå™¨å®Œå…¨è§£è€¦
- æ˜“äºæ‰©å±•å’Œä¿®æ”¹
- ä»£ç æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´

## ğŸ¯ æ¨¡å‹è¯´æ˜

æœ¬æ¡†æ¶å®ç°äº† 2D Fourier Neural Operator (FNO)ï¼Œç”¨äºå­¦ä¹ æœ€ä¼˜ä¼ è¾“é—®é¢˜ï¼š

- **è¾“å…¥**: å¯†åº¦å‡½æ•° Ï_Tï¼Œshape (1, H, W)
- **è¾“å‡º**: æœ€ä¼˜ä¼ è¾“æ˜ å°„ Tï¼Œshape (2, H, W)
- **æŸå¤±å‡½æ•°**: ç›¸å¯¹ L2 æŸå¤±

æ ¸å¿ƒç»„ä»¶ï¼š
- `SpectralConv2d`: å‚…é‡Œå¶è°±å·ç§¯å±‚
- `FNO2d`: å®Œæ•´çš„ FNO æ¨¡å‹

## ğŸ”§ æ‰©å±•å»ºè®®

### ä½¿ç”¨çœŸå®æ•°æ®
æ¡†æ¶å·²å†…ç½®å¯¹çœŸå®OTæ•°æ®çš„æ”¯æŒï¼š

1. **ä»å›¾åƒå’Œç½‘æ ¼æ–‡ä»¶è¯»å–**ï¼ˆæ¨èï¼‰
   - ä½¿ç”¨ `RealOTDataset` ç±»
   - ä¿®æ”¹ `configs/real_data_config.yaml` ä¸­çš„è·¯å¾„
   - è®¾ç½® `use_real_data: true`

2. **è‡ªå®šä¹‰æ•°æ®åŠ è½½å™¨**
   - ç»§æ‰¿ `torch.utils.data.Dataset`
   - åœ¨ `src/datasets.py` ä¸­æ·»åŠ æ–°çš„æ•°æ®é›†ç±»
   - åœ¨ `get_data_loaders` å‡½æ•°ä¸­æ·»åŠ ç›¸åº”é€»è¾‘

### æ·»åŠ æ–°çš„æ¨¡å‹
1. åœ¨ `src/model.py` ä¸­å®šä¹‰æ–°æ¨¡å‹
2. åœ¨ `main.py` ä¸­åˆ‡æ¢æ¨¡å‹åˆå§‹åŒ–
3. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„å‚æ•°

### è‡ªå®šä¹‰æŸå¤±å‡½æ•°
åœ¨ `main.py` çš„ `create_loss_fn()` å‡½æ•°ä¸­å®šä¹‰æ–°çš„æŸå¤±å‡½æ•°ã€‚

## ğŸ“š å‚è€ƒæ–‡çŒ®

Fourier Neural Operator ç›¸å…³è®ºæ–‡ï¼š
- Li, Z., et al. "Fourier Neural Operator for Parametric Partial Differential Equations." ICLR 2021.

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æå‡ºé—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

